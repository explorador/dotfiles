#!/bin/sh

tput setaf 7
tput smso;  echo " Running apps configuration file. "; tput rmso
tput sgr0


# Get email from iCloud account (or prompt if not signed in).
email=$(/usr/libexec/PlistBuddy -c "print :Accounts:0:AccountID" ~/Library/Preferences/MobileMeAccounts.plist 2>/dev/null)
if [ -z "$email" ]; then
    read -p "Enter your email: " email
fi


# Firefox default settings.
# ----------------------------------------------------------------
# Open firefox.
open "/Applications/Firefox Developer Edition.app"
sleep 3
# Close app.
killall "firefox" &> /dev/null
sleep 1
# Copy firefox profile styles.
cp -R ~/.dotfiles/config/apps/firefox/chrome ~/Library/Application\ Support/Firefox/Profiles/*.dev-edition-default
# Copy firefox default config.
cp ~/.dotfiles/config/apps/firefox/autoconfig.js /Applications/Firefox\ Developer\ Edition.app/Contents/Resources/defaults/pref
cp ~/.dotfiles/config/apps/firefox/mozilla.cfg /Applications/Firefox\ Developer\ Edition.app/Contents/Resources

# Wait 1 second.
sleep 1


# Kitty icon.
# ----------------------------------------------------------------
# Replace default icon with custom dark icon.
cp ~/.dotfiles/config/apps/kitty/kitty-dark.icns /Applications/kitty.app/Contents/Resources/kitty.icns
# Touch app bundle to invalidate cache.
touch /Applications/kitty.app
# Clear icon cache and restart Dock.
sudo rm -rf /Library/Caches/com.apple.iconservices.store 2>/dev/null
killall Dock

# Wait 1 second.
sleep 1


# Git & GitHub CLI.
# ----------------------------------------------------------------
git config --global color.ui true
git config --global user.name "Cristian"
git config --global user.email $email

# Generate SSH key if it doesn't exist.
if [ ! -f ~/.ssh/id_rsa ]; then
    ssh-keygen -t rsa -b 4096 -C $email
fi

# Authenticate with GitHub CLI (uploads SSH key for authentication).
echo "Authenticate with GitHub in your browser."
gh auth login --git-protocol ssh

# Upload same SSH key for commit signing.
gh ssh-key add ~/.ssh/id_rsa.pub --type signing --title "Signing key ($(hostname))"

# Configure Git to sign commits with SSH key.
git config --global gpg.format ssh
git config --global user.signingkey ~/.ssh/id_rsa.pub
git config --global commit.gpgsign true

# Verify SSH connection.
ssh -T git@github.com

# Wait 1 second.
sleep 1


# Fliqlo (Screensaver).
# ----------------------------------------------------------------
# Set time to 300 seconds.
defaults -currentHost write com.apple.screensaver idleTime -int 300
# Set Fliqlo as screensaver.
defaults -currentHost write com.apple.screensaver moduleDict -dict \
	moduleName -string "Fliqlo" \
	path -string "$HOME/Library/Screen Savers/Fliqlo.saver" \
	type -int 0

# Wait 1 second.
sleep 1


# iTerm settings.
# ----------------------------------------------------------------
# Open app
open "/Applications/iTerm.app"
sleep 3
# Close app
killall "iTerm2" &> /dev/null
sleep 1
# Specify iTerm preferences directory
defaults write com.googlecode.iterm2.plist PrefsCustomFolder -string "$HOME/.dotfiles/config/apps/iTerm"
# Tell iTerm2 to use the custom preferences in the directory
defaults write com.googlecode.iterm2.plist LoadPrefsFromCustomFolder -bool true

# Wait 1 second.
sleep 1


# Jumpshare.
# ----------------------------------------------------------------
# Open app
open "/Applications/Jumpshare.app"
sleep 3
# Close app
killall "Jumpshare" &> /dev/null
sleep 1
# Take & Edit Screenshot shortcut
defaults write com.jumpshare.Jumpshare hotkeyannotation -dict \
	characters -int 4 \
	charactersIgnoringModifiers -string "$" \
	keyCode -int 21 \
	modifierFlags -int 1179648

# Wait 1 second.
sleep 1


# Mail settings.
# ----------------------------------------------------------------
# Open Mail.
open "/System/Applications/Mail.app"
sleep 3
# Close app
killall "Mail" &> /dev/null
# Disable "Use dark backgrounds for messages".
defaults write com.apple.mail ViewMessagesWithDarkBackgrounds -bool false
# Enable "Show most recent message at the top".
defaults write com.apple.mail ConversationViewSortDescending -bool true
# Enable "Use the same message format as the original message" (Preferences > Composing).
defaults write com.apple.mail AutoReplyFormat -bool true
# Disable "Increase quote level" (Preferences > Composing).
defaults write com.apple.mail SupressQuoteBarsInComposeWindows -bool false

# Wait 1 second.
sleep 1


# Rectangle settings.
# ----------------------------------------------------------------
# Open Rectangle.
open "/Applications/Rectangle.app"
# Prompt action.
echo "Authorize app"
read -p "Once it's done, press enter to continue"
sleep 3
# Close app
killall "Rectangle" &> /dev/null

# Set "Spectacle mode" shortcuts
defaults write com.knollsoft.Rectangle alternateDefaultShortcuts -bool false
# Set cycling behavior to "Spectacle mode"
defaults write com.knollsoft.Rectangle subsequentExecutionMode -int 0
# Open app again.
open "/Applications/Rectangle.app"

# Wait 1 second.
sleep 1

# macOS Keyboard Shortcuts settings.
# ----------------------------------------------------------------
# Disable "Search man Page Index in Terminal" service.
# Create temporary settings file.
TEMP_SETTINGS_FILE=$(mktemp -t 'man-shortcuts-off.json') && cat > $TEMP_SETTINGS_FILE <<EOF
{
  "NSServicesStatus": {
    "com.apple.Terminal - Search man Page Index in Terminal - searchManPages": {
      "presentation_modes": {
        "ContextMenu": false,
        "ServicesMenu": false
      },
      "enabled_context_menu": false,
      "enabled_services_menu": false
    }
  }
}
EOF
# Convert to XML and apply settings.
plutil -convert xml1 -o - ${TEMP_SETTINGS_FILE} | defaults import pbs - && rm ${TEMP_SETTINGS_FILE} && /System/Library/CoreServices/pbs -flush && killall pbs